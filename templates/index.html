<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{ language.title }}</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/sweetalert2@11.7.32/dist/sweetalert2.min.css" rel="stylesheet">
    <style>
        .device-card {
            transition: transform 0.2s;
        }
        .device-card:hover {
            transform: translateY(-5px);
        }
        .status-badge {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            display: inline-block;
            margin-right: 5px;
        }
        .status-online {
            background-color: #28a745;
        }
        .status-offline {
            background-color: #dc3545;
        }
        .language-switcher {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 1000;
        }
        .language-switcher img {
            width: 32px;
            height: 32px;
            margin: 0 5px;
            cursor: pointer;
            border-radius: 4px;
            transition: transform 0.2s;
        }
        .language-switcher img:hover {
            transform: scale(1.1);
        }
        .language-switcher img.active {
            box-shadow: 0 0 0 2px #007bff;
        }
    </style>
</head>
<body>
    <div class="language-switcher">
        <img src="https://cdn.jsdelivr.net/gh/hampusborgos/country-flags@main/svg/cn.svg" 
             alt="中文" 
             onclick="changeLanguage('zh')" 
             class="lang-flag {{ 'active' if lang == 'zh' else '' }}"
             data-lang="zh">
        <img src="https://cdn.jsdelivr.net/gh/hampusborgos/country-flags@main/svg/gb.svg" 
             alt="English" 
             onclick="changeLanguage('en')" 
             class="lang-flag {{ 'active' if lang == 'en' else '' }}"
             data-lang="en">
    </div>
    <div class="container py-4">
        <div class="mb-3">
            <h1>{{ language.title }}</h1>
            <div class="btn-group">
                <button class="btn btn-primary" onclick="showAddDeviceModal()">
                    <i class="bi bi-plus-lg"></i> {{ language.add_device }}
                </button>
                <button class="btn btn-success" onclick="exportDevices()">
                    <i class="bi bi-download"></i> {{ language.export }}
                </button>
                <button class="btn btn-warning" onclick="document.getElementById('importFile').click()">
                    <i class="bi bi-upload"></i> {{ language.import }}
                </button>
                <input type="file" id="importFile" style="display:none" accept=".json" onchange="importDevices()">
            </div>
        </div>

        <div class="row" id="devices-container">
            <!-- 设备卡片将通过JavaScript动态添加 -->
        </div>
    </div>

    <!-- 添加设备模态框 -->
    <div class="modal fade" id="addDeviceModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">{{ language.add_device }}</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="addDeviceForm">
                        <div class="mb-3">
                            <label class="form-label">{{ language.device_name }}</label>
                            <input type="text" class="form-control" name="name" required>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">{{ language.ip_address }}</label>
                            <input type="text" class="form-control" name="ip" required 
                                   pattern="^((25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)\.){3}(25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)$">
                        </div>
                        <div class="mb-3">
                            <label class="form-label">{{ language.mac_address }}</label>
                            <input type="text" class="form-control" name="mac" required 
                                   pattern="^([0-9A-Fa-f]{2}[:-]){5}([0-9A-Fa-f]{2})$">
                        </div>
                        <div class="mb-3">
                            <label class="form-label">{{ language.broadcast_address }}</label>
                            <input type="text" class="form-control" name="broadcast" 
                                   pattern="^((25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)\.){3}(25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)$"
                                   placeholder="{{ language.auto_calculate }}">
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">{{ language.cancel }}</button>
                    <button type="button" class="btn btn-primary" onclick="addDevice()">{{ language.save }}</button>
                </div>
            </div>
        </div>
    </div>

    <!-- 编辑设备模态框 -->
    <div class="modal fade" id="editDeviceModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">{{ language.edit_device }}</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="editDeviceForm">
                        <input type="hidden" name="id">
                        <div class="mb-3">
                            <label class="form-label">{{ language.device_name }}</label>
                            <input type="text" class="form-control" name="name" required>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">{{ language.ip_address }}</label>
                            <input type="text" class="form-control" name="ip" required 
                                   pattern="^((25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)\.){3}(25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)$">
                        </div>
                        <div class="mb-3">
                            <label class="form-label">{{ language.mac_address }}</label>
                            <input type="text" class="form-control" name="mac" required 
                                   pattern="^([0-9A-Fa-f]{2}[:-]){5}([0-9A-Fa-f]{2})$">
                        </div>
                        <div class="mb-3">
                            <label class="form-label">{{ language.broadcast_address }}</label>
                            <input type="text" class="form-control" name="broadcast"
                                   pattern="^((25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)\.){3}(25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)$"
                                   placeholder="{{ language.auto_calculate }}">
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">{{ language.cancel }}</button>
                    <button type="button" class="btn btn-primary" onclick="updateDevice()">{{ language.save }}</button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11.7.32/dist/sweetalert2.all.min.js"></script>
    <script>
        // 在全局作用域存储语言数据
        const currentLanguage = {{ language|tojson|safe }};
        const currentLang = "{{ lang }}";

        // 模态框实例
        let addModal, editModal;

        // 当前正在编辑的设备ID
        let currentEditingId;

        document.addEventListener('DOMContentLoaded', function() {
            addModal = new bootstrap.Modal(document.getElementById('addDeviceModal'));
            editModal = new bootstrap.Modal(document.getElementById('editDeviceModal'));
            loadDevices();
            // 每30秒刷新一次设备状态
            setInterval(updateAllDevicesStatus, 30000);
        });

        function showAddDeviceModal() {
            document.getElementById('addDeviceForm').reset();
            addModal.show();
        }

        function showEditDeviceModal(device) {
            currentEditingId = device.id;
            const form = document.getElementById('editDeviceForm');
            form.elements['name'].value = device.name;
            form.elements['ip'].value = device.ip;
            form.elements['mac'].value = device.mac;
            form.elements['broadcast'].value = device.broadcast;
            editModal.show();
        }

        async function loadDevices() {
            try {
                const response = await fetch('/api/devices');
                const devices = await response.json();
                displayDevices(devices);
                // 设备显示后，检查所有设备的状态
                devices.forEach(device => {
                    checkStatus(device.id);
                });
            } catch (error) {
                showError('加载设备列表失败');
            }
        }

        function displayDevices(devices) {
            const container = document.getElementById('devices-container');
            container.innerHTML = '';
            
            devices.forEach(device => {
                const card = document.createElement('div');
                card.className = 'col-md-4 mb-4';
                card.innerHTML = `
                    <div class="card device-card">
                        <div class="card-body">
                            <div class="d-flex justify-content-between align-items-center mb-2">
                                <h5 class="card-title mb-0">${device.name}</h5>
                                <span class="status-badge" id="status-${device.id}" title="${currentLanguage.checking}"></span>
                            </div>
                            <p class="card-text">
                                ${currentLanguage.ip_address}: ${device.ip}<br>
                                ${currentLanguage.mac_address}: ${device.mac}<br>
                                ${currentLanguage.broadcast_address}: ${device.broadcast}
                            </p>
                            <div class="btn-group">
                                <button class="btn btn-primary btn-sm" data-id="${device.id}" onclick="wakeDevice(${device.id})">
                                    ${currentLanguage.wake}
                                </button>
                                <button class="btn btn-info btn-sm" data-id="${device.id}" onclick="checkStatus(${device.id})">
                                    ${currentLanguage.status}
                                </button>
                                <button class="btn btn-warning btn-sm" data-device='${JSON.stringify(device)}' onclick="showEditDeviceModal(this.dataset.device)">
                                    ${currentLanguage.edit_device}
                                </button>
                                <button class="btn btn-danger btn-sm" data-id="${device.id}" onclick="deleteDevice(${device.id})">
                                    ${currentLanguage.delete}
                                </button>
                            </div>
                        </div>
                    </div>
                `;
                container.appendChild(card);
            });
        }

        async function addDevice() {
            const form = document.getElementById('addDeviceForm');
            if (!form.checkValidity()) {
                form.reportValidity();
                return;
            }

            const formData = {
                name: form.elements['name'].value,
                ip: form.elements['ip'].value,
                mac: form.elements['mac'].value,
                broadcast: form.elements['broadcast'].value
            };

            try {
                const response = await fetch('/api/devices', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(formData)
                });

                if (response.ok) {
                    addModal.hide();
                    showSuccess(currentLanguage.device_added);
                    loadDevices();
                } else {
                    throw new Error(currentLanguage.device_add_failed);
                }
            } catch (error) {
                showError(error.message);
            }
        }

        async function updateDevice() {
            const form = document.getElementById('editDeviceForm');
            if (!form.checkValidity()) {
                form.reportValidity();
                return;
            }

            const formData = {
                name: form.elements['name'].value,
                ip: form.elements['ip'].value,
                mac: form.elements['mac'].value,
                broadcast: form.elements['broadcast'].value
            };

            try {
                const response = await fetch(`/api/devices/${currentEditingId}`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(formData)
                });

                if (response.ok) {
                    editModal.hide();
                    showSuccess(currentLanguage.device_updated);
                    loadDevices();
                } else {
                    throw new Error(currentLanguage.device_update_failed);
                }
            } catch (error) {
                showError(error.message);
            }
        }

        async function deleteDevice(id) {
            const result = await Swal.fire({
                title: currentLanguage.confirm_delete,
                text: currentLanguage.confirm_delete_message,
                icon: 'warning',
                showCancelButton: true,
                confirmButtonText: currentLanguage.confirm_delete_button,
                cancelButtonText: currentLanguage.cancel
            });

            if (result.isConfirmed) {
                try {
                    const response = await fetch(`/api/devices/${id}`, {
                        method: 'DELETE'
                    });

                    if (response.ok) {
                        showSuccess(currentLanguage.device_deleted);
                        loadDevices();
                    } else {
                        throw new Error(currentLanguage.device_delete_failed);
                    }
                } catch (error) {
                    showError(error.message);
                }
            }
        }

        async function wakeDevice(id) {
            try {
                const response = await fetch(`/api/devices/${id}/wake`, {
                    method: 'POST'
                });
                const result = await response.json();

                if (result.success) {
                    showSuccess(currentLanguage.wake_signal_sent);
                    setTimeout(() => checkStatus(id), 5000); // 5秒后检查状态
                } else {
                    throw new Error(currentLanguage.wake_signal_failed);
                }
            } catch (error) {
                showError(error.message);
            }
        }

        async function checkStatus(id) {
            try {
                const response = await fetch(`/api/devices/${id}/status`);
                const result = await response.json();
                updateDeviceStatus(id, result.online);
            } catch (error) {
                showError(currentLanguage.status_check_failed);
            }
        }

        async function updateAllDevicesStatus() {
            const devices = document.querySelectorAll('.device-card');
            devices.forEach(async (device) => {
                const id = device.querySelector('.btn-primary').getAttribute('onclick').match(/\d+/)[0];
                await checkStatus(id);
            });
        }

        function updateDeviceStatus(id, online) {
            const badge = document.getElementById(`status-${id}`);
            if (badge) {
                badge.className = `status-badge ${online ? 'status-online' : 'status-offline'}`;
                badge.title = online ? 'Online' : 'Offline';
            }
        }

        function showSuccess(message) {
            Swal.fire({
                title: currentLanguage.success,
                text: message,
                icon: 'success',
                timer: 2000,
                showConfirmButton: false
            });
        }

        function showError(message) {
            Swal.fire({
                title: currentLanguage.error,
                text: message,
                icon: 'error'
            });
        }

        async function exportDevices() {
            try {
                const response = await fetch('/api/devices/export');
                if (!response.ok) {
                    throw new Error(currentLanguage.export_failed);
                }
                const blob = await response.blob();
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;

                // 从响应头中获取文件名
                const contentDisposition = response.headers.get('Content-Disposition');
                const filename = contentDisposition ? contentDisposition.split('filename=')[1].replace(/"/g, '') : 'devices_export.json';
                a.download = filename;
                
                document.body.appendChild(a);
                a.click();
                window.URL.revokeObjectURL(url);
                document.body.removeChild(a);
                showSuccess(currentLanguage.export_success);
            } catch (error) {
                showError(error.message);
            }
        }

        async function importDevices() {
            const fileInput = document.getElementById('importFile');
            const file = fileInput.files[0];
            if (!file) return;

            const formData = new FormData();
            formData.append('file', file);

            try {
                const response = await fetch('/api/devices/import', {
                    method: 'POST',
                    body: formData
                });

                if (response.ok) {
                    showSuccess(currentLanguage.import_success);
                    loadDevices();
                } else {
                    throw new Error(currentLanguage.import_failed);
                }
            } catch (error) {
                showError(error.message);
            }
            fileInput.value = '';
        }

        function showEditDeviceModal(deviceJson) {
            const device = typeof deviceJson === 'string' ? JSON.parse(deviceJson) : deviceJson;
            currentEditingId = device.id;
            const form = document.getElementById('editDeviceForm');
            form.elements['name'].value = device.name;
            form.elements['ip'].value = device.ip;
            form.elements['mac'].value = device.mac;
            form.elements['broadcast'].value = device.broadcast;
            const editModal = new bootstrap.Modal(document.getElementById('editDeviceModal'));
            editModal.show();
        }

        async function updateDevice() {
            const form = document.getElementById('editDeviceForm');
            const formData = {
                name: form.elements['name'].value,
                ip: form.elements['ip'].value,
                mac: form.elements['mac'].value,
                broadcast: form.elements['broadcast'].value
            };

            try {
                const response = await fetch(`/api/devices/${currentEditingId}`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(formData)
                });

                if (response.ok) {
                    const editModal = bootstrap.Modal.getInstance(document.getElementById('editDeviceModal'));
                    editModal.hide();
                    showSuccess(currentLanguage.device_updated);
                    loadDevices();
                } else {
                    throw new Error(currentLanguage.device_update_failed);
                }
            } catch (error) {
                showError(error.message);
            }
        }

        function changeLanguage(lang) {
            // 更新所有国旗图标的active状态
            document.querySelectorAll('.lang-flag').forEach(flag => {
                flag.classList.toggle('active', flag.dataset.lang === lang);
            });
            // 重定向到选择的语言版本
            window.location.href = `/${lang}/`;
        }
    </script>
</body>
</html>
